#pragma kernel CSMain

struct Agent
{
    float2 position;
    float angle;
};

RWStructuredBuffer<Agent> agents;
RWTexture2D<float> trail;

cbuffer Params
{
    float moveSpeed;
    float turnAngle;
    float sensorOffset;
    float randomJitter;
    float depositAmount;
    int width;
    int height;
    uint numAgents;
};

float rand(float2 co)
{
    return frac(sin(dot(co, float2(12.9898, 78.233))) * 43758.5453);
}

int2 WrapPosition(float2 p)
{
    int x = (int) fmod(p.x + width, width);
    int y = (int) fmod(p.y + height, height);
    return int2(x, y);
}

float SenseTrail(Agent a, float offset)
{
    float ang = a.angle + offset;
    float2 dir = float2(cos(ang), sin(ang));
    float2 p = a.position + dir * sensorOffset;
    int2 ip = WrapPosition(p);
    return trail[ip];
}

[numthreads(256, 1, 1)]
void CSMain(uint id : SV_DispatchThreadID)
{
    if (id >= numAgents)
        return;

    Agent a = agents[id];

    float left = SenseTrail(a, -turnAngle);
    float center = SenseTrail(a, 0);
    float right = SenseTrail(a, turnAngle);

    if (left > center && left > right)
        a.angle -= turnAngle;
    else if (right > center && right > left)
        a.angle += turnAngle;

    a.angle += (rand(a.position) - 0.5) * randomJitter;

    float2 vel = float2(cos(a.angle), sin(a.angle)) * moveSpeed;
    a.position += vel;
    a.position = float2(
        fmod(a.position.x + width, width),
        fmod(a.position.y + height, height)
    );

    int2 pix = int2(a.position);
    trail[pix] += depositAmount;

    agents[id] = a;
}
